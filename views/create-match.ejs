<%- include('partials/header') %>

<div class="create-match-container">
    <h2 class="page-title">試合作成</h2>
    
    <% if (error) { %>
        <div class="error-message"><%= error %></div>
    <% } %>
    
    <form id="createMatchForm" action="/quiz/create-match" method="POST">
        <div class="form-group">
            <label for="title">試合タイトル</label>
            <input type="text" id="title" name="title" required placeholder="例: 数学クイズ対戦">
        </div>
        
        <div class="form-group">
            <label for="format">試合形式</label>
            <select id="format" name="format" required onchange="updateQuizRequirement()">
                <option value="">選択してください</option>
                <option value="BO3">BO3 (3本先取)</option>
                <option value="BO5">BO5 (5本先取)</option>
            </select>
            <small id="formatHelp" class="form-help">BO3: 2勝で勝利、BO5: 3勝で勝利</small>
        </div>
        
        <div class="form-group">
            <label for="opponent">対戦相手 (オプション)</label>
            <input type="text" id="opponent" name="opponent" placeholder="対戦相手のユーザー名 (後で招待も可能)">
            <small class="form-help">空白の場合は後から対戦相手を招待できます</small>
        </div>
        
        <div class="form-group">
            <label>使用するクイズ</label>
            <div id="quizRequirement" class="quiz-requirement">
                試合形式を選択してください
            </div>
            
            <% if (quizzes.length === 0) { %>
                <div class="no-quizzes">
                    <p>使用できるクイズがありません。</p>
                    <a href="/quiz/create-quiz" class="btn btn-primary">クイズを作成する</a>
                </div>
            <% } else { %>
                <div class="quiz-selection">
                    <% quizzes.forEach((quiz, index) => { %>
                        <div class="quiz-item">
                            <input type="checkbox" id="quiz_<%= index %>" name="selectedQuizzes" value="<%= quiz.id %>">
                            <label for="quiz_<%= index %>">
                                <strong><%= quiz.title %></strong>
                                <span class="quiz-info">(<%= quiz.subject %> - <%= quiz.questions.length %>問)</span>
                            </label>
                        </div>
                    <% }); %>
                </div>
            <% } %>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="submitBtn" disabled>試合を作成</button>
            <a href="/quiz/matches" class="btn btn-secondary">キャンセル</a>
        </div>
    </form>
</div>

<script>
function updateQuizRequirement() {
    const format = document.getElementById('format').value;
    const requirement = document.getElementById('quizRequirement');
    const submitBtn = document.getElementById('submitBtn');
    
    if (format === 'BO3') {
        requirement.textContent = 'BO3形式: 最低3つのクイズを選択してください';
        requirement.className = 'quiz-requirement active';
    } else if (format === 'BO5') {
        requirement.textContent = 'BO5形式: 最低5つのクイズを選択してください';
        requirement.className = 'quiz-requirement active';
    } else {
        requirement.textContent = '試合形式を選択してください';
        requirement.className = 'quiz-requirement';
    }
    
    validateForm();
}

function validateForm() {
    const format = document.getElementById('format').value;
    const selectedQuizzes = document.querySelectorAll('input[name="selectedQuizzes"]:checked');
    const submitBtn = document.getElementById('submitBtn');
    const title = document.getElementById('title').value.trim();
    
    let requiredQuizCount = 0;
    if (format === 'BO3') requiredQuizCount = 3;
    if (format === 'BO5') requiredQuizCount = 5;
    
    const isValid = title && format && selectedQuizzes.length >= requiredQuizCount;
    submitBtn.disabled = !isValid;
}

// イベントリスナーを追加
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('title').addEventListener('input', validateForm);
    document.getElementById('format').addEventListener('change', validateForm);
    
    const quizCheckboxes = document.querySelectorAll('input[name="selectedQuizzes"]');
    quizCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', validateForm);
    });
});
</script>

<style>
.create-match-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.form-group input, .form-group select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
}

.form-help {
    display: block;
    margin-top: 5px;
    color: #666;
    font-size: 14px;
}

.quiz-requirement {
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 15px;
    background-color: #f5f5f5;
    color: #666;
}

.quiz-requirement.active {
    background-color: #e3f2fd;
    color: #1976d2;
    border: 1px solid #bbdefb;
}

.quiz-selection {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 10px;
}

.quiz-item {
    display: flex;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}

.quiz-item:last-child {
    border-bottom: none;
}

.quiz-item input[type="checkbox"] {
    width: auto;
    margin-right: 10px;
}

.quiz-item label {
    margin: 0;
    cursor: pointer;
    flex: 1;
}

.quiz-info {
    color: #666;
    font-size: 14px;
}

.no-quizzes {
    text-align: center;
    padding: 40px 20px;
    background-color: #f5f5f5;
    border-radius: 4px;
}

.form-actions {
    display: flex;
    gap: 10px;
    margin-top: 30px;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
}

.btn-primary {
    background-color: #007bff;
    color: white;
}

.btn-primary:disabled {
    background-color: #ccc;
    cursor: not-allowed;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}

.error-message {
    background-color: #f8d7da;
    color: #721c24;
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 20px;
}
</style>

<%- include('partials/footer') %>