<%- include('../partials/header') %>

<div class="page-container">
    <div class="page-header">
        <div class="page-header-content">
            <h1 class="page-title">
                <i class="fas fa-users"></i>
                チームメンバー管理
            </h1>
            <div class="page-actions">
                <a href="/matches" class="button secondary">
                    <i class="fas fa-arrow-left"></i> 試合結果に戻る
                </a>
                <button type="button" class="button primary" onclick="showAddMemberModal()">
                    <i class="fas fa-plus"></i> メンバーを追加
                </button>
            </div>
        </div>
    </div>

    <% if (message) { %>
        <div class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            <%= message %>
        </div>
    <% } %>

    <% if (error) { %>
        <div class="alert alert-error">
            <i class="fas fa-exclamation-circle"></i>
            <%= error %>
        </div>
    <% } %>

    <div class="content-container">
        <% if (members.length === 0) { %>
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-users"></i>
                </div>
                <h3>チームメンバーがいません</h3>
                <p>最初のチームメンバーを追加してください。</p>
                <button type="button" class="button primary" onclick="showAddMemberModal()">
                    <i class="fas fa-plus"></i> メンバーを追加
                </button>
            </div>
        <% } else { %>
            <div class="members-grid">
                <% members.forEach(member => { %>
                    <div class="member-card <%= member.isActive ? 'active' : 'inactive' %>">
                        <div class="member-header">
                            <div class="member-name">
                                <i class="fas fa-user"></i>
                                <%= member.name %>
                            </div>
                            <div class="member-status">
                                <% if (member.isActive) { %>
                                    <span class="status-badge active">アクティブ</span>
                                <% } else { %>
                                    <span class="status-badge inactive">非アクティブ</span>
                                <% } %>
                            </div>
                        </div>
                        
                        <div class="member-details">
                            <div class="member-info">
                                <div class="info-item">
                                    <i class="fab fa-discord"></i>
                                    <strong>Discord ID:</strong> <%= member.discordId %>
                                </div>
                                <% if (member.position) { %>
                                    <div class="info-item">
                                        <i class="fas fa-tag"></i>
                                        <strong>ポジション:</strong> <%= member.position %>
                                    </div>
                                <% } %>
                                <div class="info-item">
                                    <i class="fas fa-calendar-plus"></i>
                                    <strong>登録日:</strong> <%= new Date(member.createdAt.toDate()).toLocaleDateString('ja-JP') %>
                                </div>
                            </div>
                        </div>
                        
                        <div class="member-actions">
                            <button type="button" 
                                    class="button small primary" 
                                    onclick="showEditMemberModal('<%= member.id %>', '<%= member.name %>', '<%= member.discordId %>', '<%= member.position || '' %>', <%= member.isActive %>)">
                                <i class="fas fa-edit"></i> 編集
                            </button>
                            <button type="button" 
                                    class="button small danger" 
                                    onclick="confirmDeleteMember('<%= member.id %>', '<%= member.name %>')">
                                <i class="fas fa-trash"></i> 削除
                            </button>
                        </div>
                    </div>
                <% }); %>
            </div>
        <% } %>
    </div>
</div>

<!-- メンバー追加モーダル -->
<div id="addMemberModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>チームメンバーを追加</h3>
            <button type="button" class="modal-close" onclick="hideAddMemberModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form action="/matches/members" method="POST" class="modal-form">
            <div class="form-group">
                <label for="addName" class="form-label required">
                    <i class="fas fa-user"></i>
                    名前
                </label>
                <input type="text" 
                       id="addName" 
                       name="name" 
                       class="form-input" 
                       placeholder="プレイヤー名を入力"
                       required>
            </div>

            <div class="form-group">
                <label for="addDiscordId" class="form-label required">
                    <i class="fab fa-discord"></i>
                    Discord ID
                </label>
                <input type="text" 
                       id="addDiscordId" 
                       name="discordId" 
                       class="form-input" 
                       placeholder="Discord IDを入力"
                       required>
                <small class="form-help">例: username#1234 または @username</small>
            </div>

            <div class="form-group">
                <label for="addPosition" class="form-label">
                    <i class="fas fa-tag"></i>
                    ポジション
                </label>
                <input type="text" 
                       id="addPosition" 
                       name="position" 
                       class="form-input" 
                       placeholder="ポジションを入力（任意）">
            </div>

            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" name="isActive" checked>
                    <span class="checkmark"></span>
                    アクティブ
                </label>
            </div>

            <div class="modal-actions">
                <button type="submit" class="button primary">
                    <i class="fas fa-save"></i> 追加
                </button>
                <button type="button" class="button secondary" onclick="hideAddMemberModal()">
                    <i class="fas fa-times"></i> キャンセル
                </button>
            </div>
        </form>
    </div>
</div>

<!-- メンバー編集モーダル -->
<div id="editMemberModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>チームメンバーを編集</h3>
            <button type="button" class="modal-close" onclick="hideEditMemberModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form id="editMemberForm" method="POST" class="modal-form">
            <div class="form-group">
                <label for="editName" class="form-label required">
                    <i class="fas fa-user"></i>
                    名前
                </label>
                <input type="text" 
                       id="editName" 
                       name="name" 
                       class="form-input" 
                       required>
            </div>

            <div class="form-group">
                <label for="editDiscordId" class="form-label required">
                    <i class="fab fa-discord"></i>
                    Discord ID
                </label>
                <input type="text" 
                       id="editDiscordId" 
                       name="discordId" 
                       class="form-input" 
                       required>
                <small class="form-help">例: username#1234 または @username</small>
            </div>

            <div class="form-group">
                <label for="editPosition" class="form-label">
                    <i class="fas fa-tag"></i>
                    ポジション
                </label>
                <input type="text" 
                       id="editPosition" 
                       name="position" 
                       class="form-input">
            </div>

            <div class="form-group">
                <label class="form-checkbox">
                    <input type="checkbox" id="editIsActive" name="isActive">
                    <span class="checkmark"></span>
                    アクティブ
                </label>
            </div>

            <div class="modal-actions">
                <button type="submit" class="button primary">
                    <i class="fas fa-save"></i> 更新
                </button>
                <button type="button" class="button secondary" onclick="hideEditMemberModal()">
                    <i class="fas fa-times"></i> キャンセル
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.members-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.member-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 20px;
    border: 1px solid #e1e5e9;
    transition: transform 0.2s, box-shadow 0.2s;
}

.member-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.member-card.inactive {
    opacity: 0.7;
    background: #f8f9fa;
}

.member-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e1e5e9;
}

.member-name {
    font-weight: bold;
    font-size: 16px;
    color: #333;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: bold;
    text-transform: uppercase;
}

.status-badge.active {
    background-color: #d4edda;
    color: #155724;
}

.status-badge.inactive {
    background-color: #f8d7da;
    color: #721c24;
}

.member-details {
    margin-bottom: 15px;
}

.info-item {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    font-size: 14px;
}

.info-item i {
    width: 16px;
    color: #6c757d;
}

.member-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #e1e5e9;
}

.modal-header h3 {
    margin: 0;
    color: #333;
}

.modal-close {
    background: none;
    border: none;
    font-size: 18px;
    color: #6c757d;
    cursor: pointer;
    padding: 5px;
}

.modal-close:hover {
    color: #333;
}

.modal-form {
    padding: 20px;
}

.modal-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #e1e5e9;
}

.form-checkbox {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.form-checkbox input[type="checkbox"] {
    appearance: none;
    width: 18px;
    height: 18px;
    border: 2px solid #6c757d;
    border-radius: 3px;
    position: relative;
    cursor: pointer;
}

.form-checkbox input[type="checkbox"]:checked {
    background-color: #007bff;
    border-color: #007bff;
}

.form-checkbox input[type="checkbox"]:checked::after {
    content: "✓";
    position: absolute;
    top: -2px;
    left: 2px;
    color: white;
    font-size: 14px;
    font-weight: bold;
}

.form-help {
    color: #6c757d;
    font-size: 12px;
    margin-top: 4px;
}

@media (max-width: 768px) {
    .members-grid {
        grid-template-columns: 1fr;
    }
    
    .modal-content {
        width: 95%;
        margin: 10% auto;
    }
    
    .member-actions {
        justify-content: center;
    }
}
</style>

<script>
function showAddMemberModal() {
    document.getElementById('addMemberModal').style.display = 'block';
    document.getElementById('addName').focus();
}

function hideAddMemberModal() {
    document.getElementById('addMemberModal').style.display = 'none';
    document.getElementById('addName').value = '';
    document.getElementById('addDiscordId').value = '';
    document.getElementById('addPosition').value = '';
}

function showEditMemberModal(id, name, discordId, position, isActive) {
    const modal = document.getElementById('editMemberModal');
    const form = document.getElementById('editMemberForm');
    
    form.action = '/matches/members/' + id + '/update';
    document.getElementById('editName').value = name;
    document.getElementById('editDiscordId').value = discordId;
    document.getElementById('editPosition').value = position;
    document.getElementById('editIsActive').checked = isActive;
    
    modal.style.display = 'block';
    document.getElementById('editName').focus();
}

function hideEditMemberModal() {
    document.getElementById('editMemberModal').style.display = 'none';
}

function confirmDeleteMember(id, name) {
    if (confirm('「' + name + '」を削除してもよろしいですか？\n\n注意: 試合結果で使用されているメンバーは削除できません。')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/matches/members/' + id + '/delete';
        document.body.appendChild(form);
        form.submit();
    }
}

// モーダルの外側をクリックした時に閉じる
window.onclick = function(event) {
    const addModal = document.getElementById('addMemberModal');
    const editModal = document.getElementById('editMemberModal');
    
    if (event.target === addModal) {
        hideAddMemberModal();
    }
    if (event.target === editModal) {
        hideEditMemberModal();
    }
}

// ESCキーでモーダルを閉じる
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        hideAddMemberModal();
        hideEditMemberModal();
    }
});
</script>

<%- include('../partials/footer') %>