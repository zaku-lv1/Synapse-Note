<%- include('partials/header') %>

<div class="profile-container">
    <div class="profile-header">
        <div class="profile-avatar">
            <%= (user.username || 'U').charAt(0).toUpperCase() %>
        </div>
        <div class="profile-info">
            <h1><%= user.username || 'ユーザー' %></h1>
            <p class="handle"><%= user.handle || '@unknown' %></p>
            <p class="join-date">登録日: <%= user.createdAt ? new Date(user.createdAt._seconds * 1000).toLocaleDateString('ja-JP') : '不明' %></p>
        </div>
        <% if (isOwnProfile) { %>
            <div class="profile-actions">
                <a href="/profile/edit" class="btn btn-primary">プロフィール編集</a>
                <a href="/profile/discord" class="btn btn-secondary">Discord設定</a>
            </div>
        <% } %>
    </div>

    <% if (typeof success !== 'undefined' && success) { %>
        <div class="alert alert-success">
            プロフィールが正常に更新されました。
        </div>
    <% } %>

    <div class="profile-content">
        <div class="profile-section">
            <h3>自己紹介</h3>
            <div class="bio-content">
                <% if (user.bio && user.bio.trim()) { %>
                    <p><%= user.bio %></p>
                <% } else { %>
                    <p class="no-bio">
                        <% if (isOwnProfile) { %>
                            自己紹介が設定されていません。
                        <% } else { %>
                            このユーザーは自己紹介を設定していません。
                        <% } %>
                    </p>
                <% } %>
            </div>
        </div>

        <div class="profile-section">
            <h3>統計情報</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-number"><%= stats.createdQuizzes %></span>
                    <span class="stat-label">
                        <% if (isOwnProfile) { %>
                            作成したクイズ
                        <% } else { %>
                            公開クイズ
                        <% } %>
                    </span>
                </div>
                <div class="stat-item">
                    <span class="stat-number"><%= stats.takenQuizzes %></span>
                    <span class="stat-label">受けたクイズ</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number"><%= stats.averageScore %>%</span>
                    <span class="stat-label">平均スコア</span>
                </div>
            </div>
        </div>

        <% if (isOwnProfile && user.discordMappings && user.discordMappings.length > 0) { %>
            <div class="profile-section">
                <h3>Discord設定</h3>
                <div class="discord-mappings">
                    <% user.discordMappings.slice(0, 3).forEach(mapping => { %>
                        <div class="discord-mapping-item">
                            <span class="discord-nickname"><%= mapping.nickname %></span>
                            <span class="discord-id">ID: <%= mapping.discordId %></span>
                        </div>
                    <% }); %>
                    <% if (user.discordMappings.length > 3) { %>
                        <div class="discord-more">
                            他 <%= user.discordMappings.length - 3 %> 件...
                        </div>
                    <% } %>
                    <a href="/profile/discord" class="discord-manage-link">設定を管理 →</a>
                </div>
            </div>
        <% } %>
    </div>
</div>

<script>
    // URLパラメータから成功メッセージを表示
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === '1') {
        setTimeout(() => {
            const alert = document.querySelector('.alert-success');
            if (alert) {
                alert.style.display = 'none';
            }
        }, 3000);
    }
</script>

<%- include('partials/footer') %>